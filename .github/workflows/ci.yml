# ğŸ” è‚¡å¥æª¢ LINE Bot CI ç®¡é“
# æ­¤å·¥ä½œæµç¨‹æä¾›è‡ªå‹•åŒ–ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ï¼Œé¡ä¼¼ Flutter analyze

name: CI ç®¡é“

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'functions/**'
      - '.github/workflows/**'
      - 'scripts/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'functions/**'
      - '.github/workflows/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  # ğŸ¯ ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: 'ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'
        cache-dependency-path: functions/package-lock.json

    - name: ğŸ“¦ å®‰è£ä¾è³´å¥—ä»¶
      run: cd functions && npm ci

    - name: ğŸ” åŸ·è¡Œ ESLint
      id: eslint
      run: cd functions && npm run lint

    - name: ğŸ¨ æª¢æŸ¥ Prettier æ ¼å¼
      id: prettier
      run: cd functions && npm run format:check

    - name: ğŸ—ï¸ å»ºç½®å°ˆæ¡ˆ
      id: build
      run: cd functions && npm run build

    - name: ğŸ§ª åŸ·è¡Œæœ¬åœ°æ¸¬è©¦
      id: test
      run: cd functions && npm run local-test

    - name: ğŸ“Š ç”¢ç”Ÿæª¢æŸ¥çµæœ
      run: |
        echo "# ğŸš€ CI å“è³ªå ±å‘Š" > ci-report.md
        echo "" >> ci-report.md
        echo "## ğŸ“Š çµæœæ‘˜è¦" >> ci-report.md
        echo "| æª¢æŸ¥é …ç›® | ç‹€æ…‹ |" >> ci-report.md
        echo "|-------|--------|" >> ci-report.md
        echo "| ESLint | $([ "${{ steps.eslint.outcome }}" == "success" ] && echo "âœ… é€šé" || echo "âŒ å¤±æ•—") |" >> ci-report.md
        echo "| Prettier | $([ "${{ steps.prettier.outcome }}" == "success" ] && echo "âœ… é€šé" || echo "âŒ å¤±æ•—") |" >> ci-report.md
        echo "| å»ºç½® | $([ "${{ steps.build.outcome }}" == "success" ] && echo "âœ… é€šé" || echo "âŒ å¤±æ•—") |" >> ci-report.md
        echo "| æ¸¬è©¦ | $([ "${{ steps.test.outcome }}" == "success" ] && echo "âœ… é€šé" || echo "âŒ å¤±æ•—") |" >> ci-report.md
        echo "" >> ci-report.md
        echo "## ğŸ“‹ è©³ç´°è³‡è¨Š" >> ci-report.md
        echo "- **Node.js ç‰ˆæœ¬**: $(node --version)" >> ci-report.md
        echo "- **NPM ç‰ˆæœ¬**: $(npm --version)" >> ci-report.md
        echo "- **åŸ·è¡Œæ™‚é–“**: ${{ github.event.head_commit.timestamp }}" >> ci-report.md

    - name: ğŸ“‹ ä¸Šå‚³ CI å ±å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: ci-report
        path: ci-report.md
      if: always()

    - name: ğŸ“¡ ç™¼é€ Slack é€šçŸ¥ (å¯é¸)
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        fields: repo,message
        custom_payload: |
          {
            username: 'Stock Health CI',
            icon_emoji: ':robot:',
            attachments: [{
              color: '${{ (steps.eslint.outcome == 'success' && steps.prettier.outcome == 'success' && steps.build.outcome == 'success' && steps.test.outcome == 'success') && 'good' || 'danger' }}',
              text: '${{ github.event.head_commit.message }}'
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: failure()

  # ğŸ”’ Security Check
  security:
    name: 'Security Scan'
    runs-on: ubuntu-latest
    needs: code-quality
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Run npm audit
      run: cd functions && npm audit --audit-level moderate

    - name: ğŸ›¡ï¸ Security Scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        scanners: 'vuln,secret,misconfig'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“‹ Upload Trivy results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-results.sarif
      if: always()

  # ğŸš€ Deploy to Staging
  deploy-staging:
    name: 'Deploy to Staging'
    runs-on: ubuntu-latest
    needs: [code-quality, security]
    if: github.ref == 'refs/heads/develop' && needs.code-quality.result == 'success'
    environment: staging

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup Firebase
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        projectId: stock-health-staging
        channelId: live

    - name: âœ… Verify deployment
      run: |
        echo "ğŸ” Checking deployment status..."
        curl -f https://stock-health-staging.web.app/api/health || echo "âš ï¸ Health check failed but continuing..."
        echo "âœ… Staging deployment completed"

  # ğŸ­ Deploy to Production
  deploy-production:
    name: 'Deploy to Production'
    runs-on: ubuntu-latest
    needs: [code-quality, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.code-quality.result == 'success'
    environment: production

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup Firebase
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        projectId: stock-health-app

    - name: ğŸ”¥ Deploy Functions
      run: |
        npm install -g firebase-tools
        firebase deploy --only functions --project stock-health-app --token ${{ secrets.FIREBASE_TOKEN }}

    - name: âœ… Post-deployment verification
      run: |
        echo "ğŸ” Running post-deployment checks..."
        sleep 30  # Wait for deployment to propagate
        curl -f "https://us-central1-stock-health-app.cloudfunctions.net/api/health" \
          -H "Authorization: Bearer ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}" || {
            echo "âŒ Health check failed"
            exit 1
          }
        echo "âœ… Production deployment completed successfully"

  # ğŸ“ˆ Performance Monitoring
  performance:
    name: 'Performance Check'
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“Š Bundle size analysis
      run: |
        cd functions
        if command -v webpack-bundle-analyzer >/dev/null 2>&1; then
          echo "ğŸ“¦ Bundle size analysis available"
          npx webpack-bundle-analyzer --format json
        else
          echo "â„¹ï¸ Bundle analyzer not available, skipping..."
        fi

    - name: ğŸ“ˆ Performance metrics
      run: |
        echo "â±ï¸ Deployment time: $(date)"
        echo "ğŸ“Š Performance metrics collection placeholder"
        # Add performance monitoring setup here later

  # ğŸ¯ Status Check
  status-check:
    name: 'CI Status'
    runs-on: ubuntu-latest
    needs: [code-quality, security]
    if: always()

    steps:
    - name: ğŸ“Š Final status
      run: |
        echo "ğŸ¯ CI Pipeline Summary"
        echo "======================"
        echo "ğŸ“‹ Code Quality: ${{ needs.code-quality.result }}"
        echo "ğŸ”’ Security: ${{ needs.security.result }}"
        echo "ğŸ“Š Overall Status: $(
          if [ "${{ needs.code-quality.result }}" == "success" ] && \
             ([ "${{ needs.security.result }}" == "success" ] || [ "${{ needs.security.result }}" == "skipped" ]); then
            echo "âœ… SUCCESS"
          else
            echo "âŒ FAILED"
          fi
        )"

  # ğŸ’¬ PR Comment (for Pull Requests only)
  pr-comment:
    name: 'PR Comment'
    runs-on: ubuntu-latest
    needs: code-quality
    if: github.event_name == 'pull_request'

    steps:
    - name: ğŸ’¬ Add PR comment
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `
          ## ğŸ¤– CI Quality Check Results

          ### ğŸ“Š Status Summary
          - **ESLint**: ${{ steps.eslint.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed'}}
          - **Prettier**: ${{ steps.prettier.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed'}}
          - **Build**: ${{ steps.build.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed'}}
          - **Tests**: ${{ steps.test.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed'}}

          ### ğŸ”§ Next Steps
          ${steps.eslint.outcome != 'success' ? '- Run `npm run lint:fix` to fix linting issues\n' : ''}${steps.prettier.outcome != 'success' ? '- Run `npm run format` to fix formatting issues\n' : ''}${steps.build.outcome != 'success' ? '- Check build configuration\n' : ''}${steps.test.outcome != 'success' ? '- Fix test failures\n' : ''}

          [View full CI results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *This comment was automatically generated by CI Quality System*
          `
          })